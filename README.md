# Автобусный билетный сервис

## Оглавление
- [Обзор](#обзор)
- [Технологический стек и компоненты](#технологический-стек-и-компоненты)
- [Структура репозитория](#структура-репозитория)
- [Требования](#требования)
- [Переменные окружения](#переменные-окружения)
  - [Глобальный файл `.env`](#глобальный-файл-env)
  - [SMTP для уведомлений](#smtp-для-уведомлений)
  - [Фронтенд](#фронтенд)
  - [LiqPay](#liqpay)
- [Запуск в Docker](#запуск-в-docker)
- [Локальная разработка без Docker](#локальная-разработка-без-docker)
  - [Бэкенд FastAPI](#бэкенд-fastapi)
  - [Фронтенд React](#фронтенд-react)
  - [Генерация PDF](#генерация-pdf)
- [Работа с базой данных](#работа-с-базой-данных)
- [Учётная запись администратора](#учётная-запись-администратора)
- [Настройка CORS](#настройка-cors)
- [Основные API-маршруты](#основные-api-маршруты)
  - [Маршруты остановок](#маршруты-остановок)
  - [Бронирование и покупка билетов](#бронирование-и-покупка-билетов)
- [Тестирование](#тестирование)
- [Полезные команды](#полезные-команды)

## Обзор
Проект автоматизирует продажу автобусных билетов и управление рейсами. В репозитории
располагаются бэкенд на **FastAPI**, фронтенд на **React** и инфраструктура для запуска в Docker.
Сервис поддерживает публичный поиск рейсов, бронирование и оплату, а также административные
маршруты для управления расписанием и бронированиями.

## Технологический стек и компоненты
- **Backend** — FastAPI с PostgreSQL. Работа с базой реализована через собственные запросы и
  вспомогательные сервисы (например, `ticket_utils.py` для операций с билетами и `services` для
  бизнес-логики).
- **Frontend** — React-приложение, работающее поверх REST API.
- **Инфраструктура** — `docker-compose` поднимает контейнеры `db`, `backend`, `frontend` и reverse-proxy **Caddy**
  для HTTPS-терминации. Python-зависимости устанавливаются внутри контейнеров, что предотвращает конфликты с системными пакетами.

## Структура репозитория
```
backend/   # Код FastAPI-приложения, роутеры, сервисы, шаблоны писем
frontend/  # React-клиент с пользовательским интерфейсом
requirements.txt  # Python-зависимости для локального запуска
Dockerfile / docker-compose.yml  # Образы и оркестрация сервисов
tests/     # Набор интеграционных и unit-тестов
```

## Требования
- Установленные [Docker](https://www.docker.com/) и [docker-compose](https://docs.docker.com/compose/).
- Для локального запуска бэкенда без Docker понадобится Python 3.12 и системные библиотеки для WeasyPrint (см. ниже).

## Переменные окружения
### Глобальный файл `.env`
Перед запуском в Docker создайте файл `.env` в корне проекта на основе шаблона:

```bash
cp .env.example .env
```

На Windows используйте `copy .env.example .env`. Файл содержит все необходимые переменные для контейнеров.
Значения можно менять под свои нужды:

| Переменная | Назначение | Значение по умолчанию |
| ---------- | ---------- | --------------------- |
| `BACKEND_PORT` | Порт, на котором доступен FastAPI | `8000` |
| `FRONTEND_PORT` | Порт для React-приложения | `3000` |
| `POSTGRES_HOST_PORT` | Порт PostgreSQL, проброшенный на хост | `5433` |
| `ADMIN_USERNAME`, `ADMIN_PASSWORD`, `ADMIN_TOKEN` | Учётные данные администратора и токен доступа | `admin` / `admin` / `adminsecret` |
| `JWT_SECRET` | Секретный ключ подписи JWT-токенов администратора | `changeme` |
| `TICKET_LINK_SECRET` | Секрет для подписания публичных ссылок на билеты | `changeme` |
| `TICKET_LINK_TTL_DAYS` | Максимальный срок действия ссылки (в днях, но не позднее суток после отправления) | `7` |
| `APP_PUBLIC_URL` | Публичный URL приложения, используемый в письмах | `http://localhost:${FRONTEND_PORT}` |

Эндпоинт `/auth/login` выдаёт токен из `ADMIN_TOKEN`. Его нужно передавать в заголовке `Authorization`
при обращении к административным маршрутам.

### SMTP для уведомлений
Сервис отправляет уведомления по электронной почте. Укажите параметры SMTP-сервера в `.env`:

```
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USERNAME=example
SMTP_PASSWORD=changeme
SMTP_USE_TLS=true
SMTP_FROM_EMAIL=noreply@example.com
```

`SMTP_USE_TLS` принимает `true` или `false` в зависимости от необходимости защищённого соединения.

### Фронтенд
Для фронтенда создайте файл `frontend/.env` и задайте URL API:

```bash
echo "REACT_APP_API_URL=http://localhost:${BACKEND_PORT:-8000}" > frontend/.env
```

Если порт бэкенда изменён, обновите значение `REACT_APP_API_URL`, чтобы фронтенд обращался к корректному адресу.
При отсутствии переменной приложение пытается связаться с API по тому же хосту,
что и открытая страница, автоматически подставляя порт `8000`. Логику
определения порта можно изменить с помощью опциональной переменной
`REACT_APP_API_FALLBACK_PORT`.

### LiqPay
Бэкенд умеет готовить плейлоад для оплаты через LiqPay. Добавьте ключи мерчанта в `.env`:

```bash
LIQPAY_PUBLIC_KEY=<публичный_ключ>
LIQPAY_PRIVATE_KEY=<приватный_ключ>
# Опционально, код валюты (по умолчанию `UAH`)
LIQPAY_CURRENCY=UAH
```

Сервис использует эти переменные, чтобы сформировать `data` и `signature` для `POST /public/purchase/{purchase_id}/pay`.
Подробная пошаговая инструкция приведена в [backend/LIQPAY.md](backend/LIQPAY.md).

## Запуск в Docker
1. Создайте `.env` (см. выше).
2. Соберите образы:
   ```bash
   docker compose build
   ```
3. Запустите сервисы:
   ```bash
   docker compose up
   ```
   - API будет доступен через Caddy на домене из `PUBLIC_API_HOST` (HTTPS).
   - Админка может работать по HTTP на домене из `ADMIN_HOST` или напрямую по Docker-сети.

Для остановки контейнеров выполните:
```bash
docker compose down
```

Просмотреть логи конкретного сервиса можно через `docker compose logs backend` или `docker compose logs frontend`.

## Локальная разработка без Docker
### Бэкенд FastAPI
1. Создайте виртуальное окружение и установите зависимости:
   ```bash
   python -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```
2. Убедитесь, что в системе установлены зависимости для WeasyPrint (см. ниже).
3. Укажите переменную окружения `DATABASE_URL`, указывающую на экземпляр PostgreSQL:
   ```bash
   export DATABASE_URL=postgresql://postgres:postgres@localhost:${POSTGRES_HOST_PORT:-5433}/test1
   ```
4. Запустите сервер из корня проекта:
   ```bash
   python -m uvicorn backend.main:app --reload
   ```

### Фронтенд React
1. Установите зависимости:
   ```bash
   cd frontend
   npm install
   ```
2. Запустите дев-сервер:
   ```bash
   npm start
   ```
   Приложение откроется на `http://localhost:3000` (порт можно изменить переменной `FRONTEND_PORT`).

### Генерация PDF
Экспорт билетов использует WeasyPrint. В Docker образе все зависимости уже установлены, но при локальном запуске на Linux
необходимо поставить системные библиотеки (пример для Debian/Ubuntu):

```bash
sudo apt-get install libcairo2 libpango-1.0-0 libpangocairo-1.0-0 \
  libpangoft2-1.0-0 libgdk-pixbuf-2.0-0 shared-mime-info fonts-dejavu-core
```

## Работа с базой данных
По умолчанию PostgreSQL в контейнере пробрасывается на хост `localhost:${POSTGRES_HOST_PORT:-5433}` с учётными данными
`postgres`/`postgres` и базой `test1`. URL подключения совпадает с `DATABASE_URL` и может использоваться, например, для `psql`:

```bash
psql postgresql://postgres:postgres@localhost:${POSTGRES_HOST_PORT:-5433}/test1
```

Если базы ещё нет, она будет создана автоматически при первом запуске бэкенда.

## Учётная запись администратора
При инициализации базы создаётся примерная запись администратора:
- **username:** `admin`
- **email:** `admin@example.com`
- **пароль:** `admin`

Пароль хранится как bcrypt-хеш. Данные используются для базовой авторизации: эндпоинт `/auth/login`
сверяет логин и пароль с переменными окружения `ADMIN_USERNAME` и `ADMIN_PASSWORD` и при успешном входе
возвращает токен `ADMIN_TOKEN`. Его нужно передавать в заголовке `Authorization` для административных запросов.

## Настройка CORS
Бэкенд читает переменную `CORS_ORIGINS` (список адресов через запятую). По умолчанию разрешены
локальные адреса (`http://localhost:3000`, `http://localhost:3001`, `http://localhost:4000`) и
`https://client-mt.netlify.app`. Чтобы добавить новый домен, обновите переменную:

```bash
CORS_ORIGINS=http://localhost:3000,https://example.com
```

Если админский фронтенд работает на другом origin (например, `http://admin.<ip>.nip.io`), добавьте его в
`CORS_ORIGINS` или `INTERNAL_ADMIN_ORIGINS`, чтобы preflight-запросы проходили корректно.

## HTTPS reverse-proxy (Caddy)
Для продакшн-деплоя используется контейнер `caddy`, который:
- слушает порты **80/443** на хосте и автоматически получает TLS-сертификат Let’s Encrypt,
- проксирует HTTPS-запросы на backend внутри Docker-сети,
- при необходимости отдаёт админский фронтенд по HTTP.

### Настройка доменов (nip.io)
В `.env` укажите временные домены на базе IP (обязательно с дефисами):

```bash
PUBLIC_API_HOST=api.38-79-154-248.nip.io
ADMIN_HOST=admin.38-79-154-248.nip.io
```

После этого:
- **Публичный API:** `https://api.38-79-154-248.nip.io` → `backend:8000`
- **Админка по HTTP:** `http://admin.38-79-154-248.nip.io` → `frontend:3000`

Бэкенд не публикуется наружу на `:8000` (он доступен только внутри Docker-сети для Caddy и внутренних сервисов).
Перед деплоем убедитесь, что в firewall разрешены входящие **80/443**, а **8000** закрыт для внешнего доступа.

## Основные API-маршруты
Бэкенд использует множество роутеров (см. директорию `backend/routers`). Ниже перечислены ключевые группы.

### Маршруты остановок
Все маршруты `/stops` защищены административным токеном. Каждая остановка хранит названия на четырёх языках,
описание и необязательную ссылку на карту.

- `GET /stops/` — список всех остановок.
- `POST /stops/` — создание остановки. Пример тела запроса:
  ```json
  {
    "stop_name": "Москва",
    "stop_en": "Moscow",
    "stop_bg": "Москва",
    "stop_ua": "Москва",
    "description": "Центральный автовокзал",
    "location": "https://maps.google.com/?q=55.7558,37.6173"
  }
  ```
- `GET /stops/{id}` — получение остановки по идентификатору.
- `PUT /stops/{id}` — обновление остановки.
- `DELETE /stops/{id}` — удаление остановки.

### Бронирование и покупка билетов
Для покупки используется набор эндпоинтов `/book` и `/purchase`. Они принимают количество взрослых (`adult_count`) и льготных
(`discount_count`) билетов; сумма должна совпадать с размером массива `seat_nums`. Для льготных билетов применяется скидка 5 %.

Пример запроса на бронирование одного места:

```json
{
  "tour_id": 1,
  "seat_nums": [1],
  "passenger_names": ["Иван"],
  "passenger_phone": "123",
  "passenger_email": "ivan@example.com",
  "departure_stop_id": 1,
  "arrival_stop_id": 2,
  "adult_count": 1,
  "discount_count": 0
}
```

Покупка подтверждается отдельным запросом к `/purchase`, после чего билеты становятся недоступными для других пользователей.

## Тестирование
Для проверки корректности работы выполните набор автоматических тестов:

```bash
pytest
```

Тесты покрывают бизнес-логику бронирования, административные сценарии, генерацию PDF и работу публичных API.

## Полезные команды
- `docker compose logs -f backend` — потоковое наблюдение логов бэкенда.
- `docker compose exec backend alembic upgrade head` — пример миграции БД (если вы добавите Alembic).
- `docker compose exec db psql -U postgres test1` — подключение к базе из контейнера.
- `npm run build --prefix frontend` — сборка фронтенда для продакшена.
