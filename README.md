# Запуск проекта в Docker

Этот репозиторий содержит бэкенд на **FastAPI** и фронтенд на **React**.
Docker Compose поднимает отдельные контейнеры: `db`, `backend` и `frontend`.
Python-зависимости устанавливаются во внутренние окружения контейнеров, поэтому конфликты с системными пакетами исключены.

## Требования
- [Docker](https://www.docker.com/) и [docker-compose](https://docs.docker.com/compose/)

## Подготовка переменных окружения
Перед сборкой контейнеров необходимо создать файл `.env` на основе шаблона.
Файл `.env` не хранится в репозитории, поэтому его нужно создать локально:
```bash
cp .env.example .env
```
На Windows используйте `copy .env.example .env`. В файле `.env` можно
изменить порты и другие переменные окружения под свои нужды.
Для входа в административный интерфейс используйте переменные
окружения с учётными данными администратора:
```bash
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
ADMIN_TOKEN=adminsecret
JWT_SECRET=changeme
```
Значения по умолчанию совпадают с теми, что указаны выше. Токен
возвращается эндпоинтом `/auth/login` и используется в заголовке
`Authorization` при обращении к административным маршрутам.
Переменная `JWT_SECRET` задаёт ключ, которым подписываются эти токены.
Команда `docker compose` читает этот файл и без него не запустит контейнеры.

## Сборка контейнеров
```bash
docker compose build
```

## Запуск
```bash
docker compose up
```
После запуска приложение будет доступно на `http://localhost:${BACKEND_PORT:-8000}`.
При необходимости порт можно изменить в файле `.env` (переменная `BACKEND_PORT`).
Аналогично переменная `FRONTEND_PORT` управляет портом React-приложения.
Все сервисы читают эту переменную, поэтому достаточно изменить её один раз,
чтобы и Docker, и приложение использовали новый порт.

Для остановки выполнения используйте:
```bash
docker compose down
```

## Подключение к базе данных
В контейнере запускается PostgreSQL с настройками по умолчанию. Контейнерный
порт `5432` проброшен на хост. По умолчанию он маппится на `localhost:5433`,
но при необходимости это значение можно изменить переменной окружения
`POSTGRES_HOST_PORT`:
- **host:** `localhost`
- **port:** `5433` (или выбранный вами `POSTGRES_HOST_PORT`)
- **database:** `test1`
- **user:** `postgres`
- **password:** `postgres`

URL подключения доступен в переменной окружения `DATABASE_URL`. Например,
можно подключиться через `psql`:
```bash
psql postgresql://postgres:postgres@localhost:${POSTGRES_HOST_PORT:-5433}/test1
```
Если по какой-то причине база данных отсутствует, бэкенд при первом запуске
автоматически создаст её, используя те же учётные данные.

## Локальный запуск без Docker
Для разработки можно запустить сервер напрямую. Используйте Python 3.12 и установите зависимости:
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```
Перед запуском необходимо указать переменную окружения `DATABASE_URL`, чтобы
приложение подключилось к локальной базе данных:
```bash
export DATABASE_URL=postgresql://postgres:postgres@localhost:${POSTGRES_HOST_PORT:-5433}/test1
```
Запустите приложение из корня репозитория командой:
```bash
python -m uvicorn backend.main:app --reload
```
Важно запускать команду именно из корня проекта, чтобы работали относительные импорты из `backend`.

## Пользователь admin по умолчанию
После инициализации базы данных создаётся учётная запись администратора:
- **username:** `admin`
- **email:** `admin@example.com`
- **пароль:** `admin`
Пароль хранится в базе как bcrypt-хеш. Эти данные служат примером и не
используются для входа через API. Эндпоинт `/auth/login` сверяет логин и
пароль с переменными окружения `ADMIN_USERNAME` и `ADMIN_PASSWORD`.
При успешном входе возвращается токен из `ADMIN_TOKEN`, который следует
передавать в заголовке `Authorization` при обращении к административным
маршрутам.

## Настройка адреса API
Фронтенд использует переменную окружения `REACT_APP_API_URL` для обращения к бэкенду.
Создайте файл `.env` в каталоге `frontend` и укажите там URL сервера, например:
```bash
REACT_APP_API_URL=http://localhost:${BACKEND_PORT:-8000}
```
Если файл уже существует, можно изменить значение переменной на свой.
Если вы меняете `BACKEND_PORT`, не забудьте обновить и эту переменную,
чтобы фронтенд обращался к правильному порту.

## Настройка CORS
Бэкенд читает переменную окружения `CORS_ORIGINS`, содержащую список
разрешённых адресов через запятую. По умолчанию разрешены
`http://localhost:3000`, `http://localhost:3001` и `http://localhost:4000`. Если фронтенд доступен по другому адресу,
добавьте его в эту переменную:
```bash
CORS_ORIGINS=http://localhost:3000,https://example.com
```

## Эндпоинты остановок

Все маршруты `/stops` защищены административным токеном. Каждая остановка
содержит названия на четырёх языках, произвольное описание и опциональную ссылку
на карту (например, на Google Maps).

- `GET /stops/` – список всех остановок.
- `POST /stops/` – создать остановку. Пример тела запроса:

```json
{
  "stop_name": "Москва",
  "stop_en": "Moscow",
  "stop_bg": "Москва",
  "stop_ua": "Москва",
  "description": "Центральный автовокзал",
  "location": "https://maps.google.com/?q=55.7558,37.6173"
}
```

- `GET /stops/{id}` – получить остановку по идентификатору.
- `PUT /stops/{id}` – обновить существующую остановку. Тело запроса аналогично созданию и также может содержать поле `location`.
- `DELETE /stops/{id}` – удалить остановку.
